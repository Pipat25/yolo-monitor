<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO Training Metrics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        canvas { max-width: 600px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Real-time YOLO training metrics</h1>
    <canvas id="boxLossChart"></canvas>
    <canvas id="clsLossChart"></canvas>
    <canvas id="prChart"></canvas>
    <canvas id="mAPChart"></canvas>

    <script>
        let boxLossChart, clsLossChart, prChart, mAPChart;

        async function fetchMetrics() {
            const response = await fetch('/metrics');
            return await response.json();
        }

        function updateCharts(metrics) {
            if (!boxLossChart) {
                boxLossChart = new Chart(document.getElementById('boxLossChart'), {
                    type: 'line',
                    data: { labels: metrics.epochs, datasets: [
                        { label: 'Train Box Loss', data: metrics.train_box_loss, borderColor: '#ff6384', fill: false },
                        { label: 'Val Box Loss', data: metrics.val_box_loss, borderColor: '#36a2eb', fill: false }
                    ]},
                    options: { plugins: { title: { display: true, text: 'Box Loss' } } }
                });
            } else {
                boxLossChart.data.labels = metrics.epochs;
                boxLossChart.data.datasets[0].data = metrics.train_box_loss;
                boxLossChart.data.datasets[1].data = metrics.val_box_loss;
                boxLossChart.update();
            }

            if (!clsLossChart) {
                clsLossChart = new Chart(document.getElementById('clsLossChart'), {
                    type: 'line',
                    data: { labels: metrics.epochs, datasets: [
                        { label: 'Train Cls Loss', data: metrics.train_cls_loss, borderColor: '#ff6384', fill: false },
                        { label: 'Val Cls Loss', data: metrics.val_cls_loss, borderColor: '#36a2eb', fill: false }
                    ]},
                    options: { plugins: { title: { display: true, text: 'Classification Loss' } } }
                });
            } else {
                clsLossChart.data.labels = metrics.epochs;
                clsLossChart.data.datasets[0].data = metrics.train_cls_loss;
                clsLossChart.data.datasets[1].data = metrics.val_cls_loss;
                clsLossChart.update();
            }

            if (!prChart) {
                prChart = new Chart(document.getElementById('prChart'), {
                    type: 'line',
                    data: { labels: metrics.epochs, datasets: [
                        { label: 'Precision', data: metrics.precision, borderColor: '#ff9f40', fill: false },
                        { label: 'Recall', data: metrics.recall, borderColor: '#4bc0c0', fill: false }
                    ]},
                    options: { plugins: { title: { display: true, text: 'Precision & Recall' } } }
                });
            } else {
                prChart.data.labels = metrics.epochs;
                prChart.data.datasets[0].data = metrics.precision;
                prChart.data.datasets[1].data = metrics.recall;
                prChart.update();
            }

            if (!mAPChart) {
                mAPChart = new Chart(document.getElementById('mAPChart'), {
                    type: 'line',
                    data: { labels: metrics.epochs, datasets: [
                        { label: 'mAP@50', data: metrics.mAP50, borderColor: '#ffcd56', fill: false },
                        { label: 'mAP@50:95', data: metrics.mAP50_95, borderColor: '#9966ff', fill: false }
                    ]},
                    options: { plugins: { title: { display: true, text: 'mAP Metrics' } } }
                });
            } else {
                mAPChart.data.labels = metrics.epochs;
                mAPChart.data.datasets[0].data = metrics.mAP50;
                mAPChart.data.datasets[1].data = metrics.mAP50_95;
                mAPChart.update();
            }
        }

        async function refreshData() {
            try {
                const metrics = await fetchMetrics();
                updateCharts(metrics);
            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }

        // รีเฟรชข้อมูลทุก 10 วินาที
        setInterval(refreshData, 10000);
        refreshData(); // รันครั้งแรกทันที
    </script>
</body>
</html>
